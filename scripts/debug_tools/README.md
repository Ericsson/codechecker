Debug Tools
===========

These scripts may be used to aid debugging of clang crashes during analysis.
The goal is to reproduce the crash locally, i.e. using the source files in the
failure zip. During the process we take the original compile command database,
compiler includes and compiler target files and we create the modified version
of them (with `_DEBUG` postfix).  These modified files contain the paths
prefixed with the root of the source directory which holds the dependent source
files (`sources-root`).

`prepare_analyzer_cmd.py` creates a new clang static analyzer command
(`analyzer-command_DEBUG`) which may be executed immediately if cross
translation unit (CTU) was disabled.  However, to debug CTU analysis related
crashed in clang we have to synthetise the AST dump files too, so other phases
are needed which are done in `prepare_all_cmd_for_ctu.py`.  It executes
`CodeChecker` with ctu-collect, therefore `CodeChecker` must be in the `PATH`
and the proper venv must be set.

Example session for debugging a clang crash:
```sh
$ export WS=/your_own_path
$ cd reports/failed
$ unzip main.c_4c7feffae4c2b887abcdc37a3c88b2e5.plist.zip
$ $WS/CodeChecker/debug_tools/prepare_analyzer_cmd.py --clang $WS/llvm/build/debug/bin/clang --clang_plugin_name libericsson --clang_plugin_path $WS/codechecker_core_ws/build/debug/libericsson-checkers.so
$ bash analyzer-command_DEBUG
```

Example session for debugging a CTU clang crash:
```sh
$ export WS=/your_own_path
$ export PATH=$WS/CodeChecker/build/CodeChecker/bin:$PATH
$ source $WS/CodeChecker/venv_dev/bin/activate
$ cd reports/failed
$ unzip main.c_4c7feffae4c2b887abcdc37a3c88b2e5.plist.zip
$ $WS/CodeChecker/debug_tools/prepare_all_cmd_for_ctu.py --clang $WS/llvm/build/debug/bin/clang --clang_plugin_name libericsson --clang_plugin_path $WS/codechecker_core_ws/build/debug/libericsson-checkers.so
$ bash analyzer-command_DEBUG
```

## CTU crash reduction (beta)

The `reduce_ctu_crash.py` script is meant to be your all-in-one solution for
debugging a `CTU analyze` crash. It calls the `prepare_all_cmd_for_ctu.py` tool
for you (changing all paths to point to the debug environment), preprocesses
all source code files (needed for reduction), and runs
[C-Reduce](https://embed.cs.utah.edu/creduce/) on them. As an optimization, it
empties all source code files that do not contribute to the crash, speeding
up the debugging process.

#### Prerequisites

- [Ericsson/clang ctu-clang7 branch](https://github.com/Ericsson/clang/tree/ctu-clang7)
built and binary in PATH (or handed to the script as a `--clang` argument).

- [CodeChecker 6.9.1](https://github.com/Ericsson/codechecker) built as described
[here](https://github.com/Ericsson/codechecker#install-guide), binary in PATH, and 
its environment sourced:

```sh
$ export PATH=/path/to/CodeChecker/build/CodeChecker/bin:$PATH
$ source /path/to/CodeChecker/venv_dev/bin/activate
```

- [C-Reduce 2.9.0](http://embed.cs.utah.edu/creduce/creduce-2.9.0.tar.gz) built and
binaries in PATH. After unzipping / untarring, a sample installation process into a
custom directory looks like the following:

```sh
$ cd /path/to/creduce-2.9.0
$ ./configure --with-llvm=/root/of/llvm/build/tree --prefix=$PWD/build
$ make
$ make install
$ export PATH=$PWD/build/bin:$PWD/build/libexec:$PATH
```

#### Example session

```sh
$ cd reports/failed
$ /path/to/CodeChecker/scripts/debug_tools/reduce_ctu_crash.py
DummyDemanglerFuzzer.cpp_9abe7ebe728d2394966994e02e10ceb9.plist_CTU_crash.zip
-j12 >dummy.log 2>&1
```

#### Additional options

```
usage: reduce_ctu_crash.py [-h] [-j N] [-o DIR] [--analyzer-command FILE]
                           [--sources-root PATH] [--report-dir PATH]
                           [--clang PATH] [--clang-plugin-name NAME]
                           [--clang-plugin-path PATH] [--continue-reduce]
                           ZIP

Reduces reproduction files for CTU assertions (assertions only!) based on the
repro zip file generated by CodeChecker. This script requires CodeChecker to
be added to PATH and its environment sourced. You can specify which Clang to
use (it is taken from PATH by default).

positional arguments:
  ZIP                   A .zip file containing files needed for reproduction
                        (generated by CodeChecker).

optional arguments:
  -h, --help            show this help message and exit
  -j N, --jobs N        Number of threads to be used for main file reduction.
  -o DIR, --output DIR  Destination directory to hold reduced repro files.
  --analyzer-command FILE
                        Path to a script with the erroneous analyzer call.
  --sources-root PATH   Path to the sources-root directory.
  --report-dir PATH     Path to the report dir.
  --clang PATH          Path to the clang binary.
  --clang-plugin-name NAME
                        Name of the used clang plugin.
  --clang-plugin-path PATH
                        Path to the used clang plugin.
  --continue-reduce     Continue the previous run of this script.

```
